# KasmVNC Plus — Helm Values
# Default values for enterprise browser deployment

# ─── Session Pod (Browser Container) ─────────────────────────────────────────

session:
  image:
    repository: kasmvncplus
    tag: hardened
    pullPolicy: IfNotPresent

  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: "2"
      memory: 2Gi

  # Session timeouts
  timeoutMinutes: 30

  # Chromium settings
  chromium:
    maxCrashes: 5
    memoryLimit: 512  # MB — passed to --max-old-space-size

  # Service for OAuth proxy
  service:
    type: ClusterIP
    port: 8443

  # HPA for session pods
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 50
    targetCPUUtilization: 70
    targetMemoryUtilization: 80

  # Pod disruption budget
  pdb:
    enabled: true
    minAvailable: 1

  # Anti-affinity — spread session pods across nodes
  affinity:
    enabled: true
    topologyKey: kubernetes.io/hostname

  # Probes
  livenessProbe:
    path: /healthz
    port: 8443
    scheme: HTTPS
    initialDelaySeconds: 10
    periodSeconds: 30

  readinessProbe:
    path: /readyz
    port: 8443
    scheme: HTTPS
    initialDelaySeconds: 15
    periodSeconds: 10

# ─── Session Controller ──────────────────────────────────────────────────────

controller:
  enabled: true
  replicas: 2

  image:
    repository: kasmvncplus-controller
    tag: latest
    pullPolicy: IfNotPresent

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  service:
    type: ClusterIP
    port: 9090

# ─── PostgreSQL ───────────────────────────────────────────────────────────────

postgresql:
  enabled: true
  auth:
    database: kasmvnc
    username: kasmvnc
    password: kasmvnc  # Override in production!
  primary:
    persistence:
      size: 10Gi

# ─── Ingress ──────────────────────────────────────────────────────────────────

ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    # Critical: WebSocket support for VNC
    nginx.ingress.kubernetes.io/websocket-services: "kasmvnc-plus-session"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$request_uri"
  hosts:
    - host: browser.example.com
      paths:
        - path: /
          pathType: Prefix

# ─── Recordings Storage ──────────────────────────────────────────────────────

recordings:
  persistence:
    enabled: true
    storageClass: ""
    size: 50Gi
    accessMode: ReadWriteMany

# ─── OAuth / SSO ──────────────────────────────────────────────────────────────

oauth:
  provider:
    issuerUrl: "https://keycloak.example.com/realms/kasmvnc"
    clientId: "kasmvnc-plus"
    clientSecret: ""  # Set via secret
  server:
    sessionTimeoutMinutes: 30

# ─── User Profiles Storage ────────────────────────────────────────────────────

profiles:
  persistence:
    enabled: true
    storageClass: ""
    size: 20Gi
    accessMode: ReadWriteMany
